<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bomberman-DOM</title>
    <link href="../src/client/styles/map.css" rel="stylesheet">
    <link href="../src/client/styles/player.css" rel="stylesheet">
    <link href="../src/client/styles/bomb.css" rel="stylesheet">
    <link href="../src/client/styles/chat.css" rel="stylesheet">

</head>

<body>
    <!-- Bomberman Game Container -->
    <div class="game-timer"></div> <!-- Game Timer display -->

    <div id="root"></div>
    <div class="lives-display"></div>


    <!-- Chat Section -->
    <!-- <div id="chat-container" style="border-top: 1px solid #ccc; padding-top: 10px; margin-top: 20px;">
        <h2>Chat</h2>
        <div id="chat" style="height: 200px; overflow-y: auto; border: 1px solid #333; padding: 10px;"></div>
        <input type="text" id="message" placeholder="Type a message" style="width: 80%;">
        <button onclick="sendMessage()">Send</button>
    </div> -->

    <div id="chat-container" style="border-top: 1px solid #ccc; padding: 15px; background-color: #f9f9f9; border-radius: 8px; max-width: 600px; margin: 0 auto; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">
        <h2 style="color: #333; font-family: Arial, sans-serif;">Chat</h2>
        <div id="chat" style="height: 300px; overflow-y: auto; background-color: #fff; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #ddd; box-shadow: inset 0 1px 5px rgba(0, 0, 0, 0.05); color: #333;"> <!-- Add color here -->
            <!-- Chat messages will go here -->
        </div>
        <div style="display: flex;">
            <input type="text" id="message" placeholder="Type a message" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1); margin-right: 10px;">
            <button onclick="sendMessage()" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s;">Send</button>
        </div>
    </div>
    
    

    <!-- Footer -->
    <footer class="info">
        <p>Created by
            <a href="https://github.com/RupertCheetham" target="_blank" rel="noopener noreferrer">Rupert</a>,
            <a href="https://github.com/m-fenton" target="_blank" rel="noopener noreferrer">Martin</a>, and
            <a href="https://github.com/kn1ko1/" target="_blank" rel="noopener noreferrer">Knikoi</a>
        </p>
    </footer>

    <!-- Game Logic Script -->
    <script src="../src/index.js"></script> <!-- Adjusted path -->


    <script>
const ws = new WebSocket("ws://localhost:8080/ws");
let currentPlayerId; // Declare without initializing

function displayMessage(messageData, messageType) {
    // Parse messageData.text if it's in stringified JSON format
    let parsedMessage;
    try {
        parsedMessage = JSON.parse(messageData.text); // Expecting {"playerId": 1, "text": "Hello World"}
    } catch (e) {
        console.warn("Message is not in JSON format:", messageData.text);
        parsedMessage = { playerId: messageData.playerId, text: messageData.text }; // Fallback to use messageData directly
    }

    const playerId = parsedMessage.playerId || messageData.playerId;
    const messageText = parsedMessage.text || messageData.text;

    // Prevent displaying empty messages
    if (!messageText.trim()) {
        console.warn("Attempted to display an empty message.");
        return; // Exit the function if the message is empty
    }

    const chat = document.getElementById("chat");
    const message = document.createElement("div");
    message.classList.add("message", messageType); // Use messageType for styling

    // Create a bold playerId element (e.g., "Player 1:")
    const playerIdElement = document.createElement("strong");
    playerIdElement.innerText = `Player ${playerId}:`;

    // Add a line break for better formatting
    const lineBreak = document.createElement("br");

    // Create the message content element
    const messageContent = document.createElement("p");
    messageContent.innerText = messageText;

    // Append player ID, line break, and message content to the message div
    message.appendChild(playerIdElement);
    message.appendChild(lineBreak);
    message.appendChild(messageContent);

    chat.appendChild(message);
    chat.scrollTop = chat.scrollHeight; // Auto-scroll to the bottom

    // Log details for debugging
    console.log(`Message displayed [${messageType}]:`, `Player ${playerId}: ${messageText}`);
}


ws.onmessage = function(event) {
    const messageData = JSON.parse(event.data); // Expecting { "playerId": 1, "text": "Hello" }
    console.log("Message received:", messageData); // Log the incoming message

    // Determine if the message is "sent" or "received"
    let messageType;
    if (messageData.playerId === currentPlayerId) {
        messageType = "sent";
    } else {
        messageType = "received";
    }

    // If player ID is included, update currentPlayerId
    if (messageData.playerId && !currentPlayerId) {
        currentPlayerId = messageData.playerId;
        console.log("Player ID assigned:", currentPlayerId);
    }

    displayMessage(messageData, messageType); // Display the message with the correct type
};


function sendMessage() {
    const input = document.getElementById("message");
    const messageText = input.value.trim();

    if (!messageText) {
        console.warn("Cannot send an empty message.");
        return;
    }

    // Ensure player ID is defined before sending
    if (!currentPlayerId) {
        console.warn("Cannot send message: currentPlayerId is undefined.");
        return;
    }

    // Construct the message data object
    const messageData = {
        playerId: currentPlayerId,
        text: messageText
    };

    console.log("Sending message:", messageData);
    ws.send(JSON.stringify(messageData)); // Send the message as a JSON object

     // Store the last message sent
     //lastSentMessage = messageText;

     //This is displayMessage that caused the issue of double messages
    // Display the message locally as "sent"
    //displayMessage(messageData, "sent"); 
    input.value = ''; // Clear input field
}




    </script>
    
    

</body>

</html>
